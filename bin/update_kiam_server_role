#!/bin/bash
#
# Create the IAM role for the Kiam server if it does not exist

if [ -z ${AWS_ACCOUNT+x} ]
then
	echo "\$AWS_ACCOUNT must be set."
	exit 1
fi

STACK_NAME=$1
KIAM_ROLE_NAME=${2:-kiam-server}

role=$(aws cloudformation describe-stack-resource --stack-name ${STACK_NAME} --logical-resource-id NodeInstanceRole)

PRINCIPAL="arn:aws:iam::${AWS_ACCOUNT}:role/"$(echo $role | jq .StackResourceDetail.PhysicalResourceId | sed -e 's/\"//g')
base='{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Principal": {
        "Service": "ec2.amazonaws.com"
      },
      "Action": "sts:AssumeRole"
    }
  ]
}'
update='
      {
        "Effect": "Allow",
        "Principal": {
          "AWS": "PRINCIPAL"
        },
        "Action": "sts:AssumeRole"
      }'
UPDATE=$(echo $update | sed -e "s#PRINCIPAL#$PRINCIPAL#")
out=$(aws iam get-role --role-name ${KIAM_ROLE_NAME})
if [ $? -ne 0 ]
then 
    aws iam create-role --role-name ${KIAM_ROLE_NAME} --assume-role-policy-document "$base"
    policy=$base
else
    policy=$(echo "$out" | jq .Role.AssumeRolePolicyDocument)
fi

arns=$(echo "$policy"  | jq '.Statement' | jq '.[].Principal.AWS' | sed -e 's/"//g' -e "s/'//g" )
for arn in $arns
do
	if [ "$arn" == "$PRINCIPAL" ]
	then
		exit 0
	fi
done
updated=$(echo "$policy" | jq --argjson UPDATE "$UPDATE" '.Statement += [ $UPDATE ]')
aws iam update-assume-role-policy --role-name ${KIAM_ROLE_NAME} --policy-document "$updated"
