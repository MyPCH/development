#!/bin/bash
#
# Set environment variables from values file
#
# Usage: $0 $VALUES_FILE

if [ $# -ne 1 ]
then
	echo "Usage: $0 \$VALES_FILE"
	exit
fi

export VALUES_FILE=$(realpath $1)

DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" >/dev/null 2>&1 && pwd )"
export DEV_REPO=$(realpath $DIR/..)

CONFIG_PARENT_DIR=$(realpath $(yq read $VALUES_FILE global.repo.directory))
if [ -z ${CONFIG_PARENT_DIR} -o "${CONFIG_PARENT_DIR}" == "null" ]
then
	echo "global.repo.directory required."
	exit
fi

export CLUSTER_NAME=$(yq read $VALUES_FILE global.cluster.name)
if [ -z ${CLUSTER_NAME} -o "${CLUSTER_NAME}" == "null" ]
then
	echo "global.cluster.name required."
fi

export GITHUB_USER=$(yq read $VALUES_FILE global.github.user)
if [ -z "$GITHUB_USER" -o "${GITHUB_USER}" == "null" ]
then
	echo "global.github.user required."
	exit
fi

export GIT_REPO_NAME=$(yq read $VALUES_FILE global.repo.name)

if [ -z "$GIT_REPO_NAME" -o "${GIT_REPO_NAME}" == "null" ]
then
        GIT_REPO_NAME=-cluster-${CLUSTER_NAME}
fi

export CONFIG_DIR=${CONFIG_PARENT_DIR}/${GIT_REPO_NAME}
export CLUSTER_DIR=${CONFIG_DIR}/clusters/${CLUSTER_NAME}
export FLUX_DIR=${CLUSTER_DIR}/flux

export CONFIG_FILE=$(yq read $VALUES_FILE global.cluster.configFile)
if [ -z "$CONFIG_FILE" -o "${CONFIG_FILE}" == "null" ]
then
	CONFIG_FILE=$CLUSTER_DIR/config.yaml
fi

export AWS_REGION=$(yq read $VALUES_FILE global.cluster.region)
if [ -z "$CONFIG_FILE" -o "${CONFIG_FILE}" == "null" ]
then
    AWS_REGION=us-west-2
fi

export ENVIRONMENTS=$(yq r $VALUES_FILE env)
if [ "$ENVIRONMENTS" == "null" -o "$ENVIROMMENTS" == "{}" ]
then
	ENVIRONMENTS=""
else
	ENVIRONMENTS=$(echo "$ENVIRONMENTS" | grep -v ' .*' | sed 's/.$//' | paste -sd " " -)
fi


export FLUXCLOUD=$(yq read $VALUES_FILE global.fluxcloud.enabled)
if [ "${FLUXCLOUD}" == "null" ]
then
	FLUXCLOUD=""
fi

export FLUX_BRANCH=$(yq read $VALUES_FILE global.repo.branch)
if [ -z "$FLUX_BRANCH" -o "${FLUX_BRANCH}" == "null" ]
then
	FLUX_BRANCH=master
fi

export GITHUB_ACCOUNT=$(yq read $VALUES_FILE global.github.account)
if [ -z "$GITHUB_ACCOUNT" -o "${GITHUB_ACCOUNT}" == "null" ]
then
	GITHUB_ACCOUNT=tidepool-org
fi

export GIT_REMOTE=git@github.com:${GITHUB_ACCOUNT}/${GIT_REPO_NAME}.git

export KUBECONFIG=$(yq read $VALUES_FILE global.kubeconfig)
if [ "$KUBECONFIG" == "null" ]
then
	KUBECONFIG=$CLUSTER_DIR/kubeconfig.yaml
fi

export IAM_USERS=$(yq read $VALUES_FILE global.iamUsers)
if [ "$IAM_USERS" == "null" ]
then
	IAM_USERS=""
fi

if [ -f ~/.secrets/github_access_token ]
then
	export GITHUB_TOKEN=$(cat ~/.secrets/github_access_token)
else
    	export GITHUB_TOKEN=$(yq read $VALUES_FILE global.github.token)
fi
