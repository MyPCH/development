#!/bin/sh
# Retrieve key from flux and add it as a deploy key for the Git remote
# write accesss allows flux to poll Docker Hub and update Git with the latest images
# read access allows flux to poll Git for changes to the repo that it reflects in the cluster
#
# Requirements:
# 1) A Github access token must be stored in ~/.secret/github_access_token
# 2) You must have write access to the Git remote.
# 3) You must have fluxctl installed.
# 4) You must be in a valid Git repo.
#
context=$(kubectl config current-context)
github_access_token=$(cat ~/.secrets/github_access_token)
key=$(fluxctl identity)
rp=$(git rev-parse --is-inside-work-tree 2>/dev/null)

if [ $? -ne 0 ] || [ "$rp" != "true" ]; then
        echo 'Not a git repository'
        exit
fi

url="$(git config --get remote.origin.url)"
reponame="$(echo $url | cut -d/ -f2 | sed -e 's/\.git//')"
echo $reponame

curl -X POST -i\
	-H"Authorization: token $github_access_token"\
	--data @- https://api.github.com/repos/tidepool-org/$reponame/keys << EOF
{
	"title" : "weave flux key for $context $(date)",
	"key" : "$key",
	"read_only" : false
}
EOF
