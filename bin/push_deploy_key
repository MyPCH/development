#!/bin/sh
#
# Retrieve key from flux and add it as a deploy key for the Git remote
# write accesss allows flux to poll Docker Hub and update Git with the latest images
# read access allows flux to poll Git for changes to the repo that it reflects in the cluster
#
# Requirements:
# 1) You must have write access to the Git remote.
# 2) You must have fluxctl installed.
#
# Usage: $0

if [ -z "$GITHUB_TOKEN" ]
then
	echo "\$GITHUB_TOKEN" required."
	exit
fi

if [ -z "$CONFIG_REPO" ]
then
	echo "\$CONFIG_REPO required."
	exit
fi

cd $CONFIG_REPO
GIT_REMOTE=$(git config remote.origin.url)

key=$(fluxctl --k8s-fwd-ns=flux identity)

reponame="$(echo $GIT_REMOTE | cut -d/ -f2 | sed -e 's/\.git//')"
echo $reponame

curl -X POST -i\
	-H"Authorization: token $GITHUB_TOKEN"\
	--data @- https://api.github.com/repos/tidepool-org/$reponame/keys << EOF
{
	"title" : "flux key for $context $(date)",
	"key" : "$key",
	"read_only" : false
}
EOF
