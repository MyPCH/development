#!/bin/bash 
#
# Create EKS cluster and install flux
#
# Requires config.yaml file in REMOTE_REPO.
#
# Depends on eksctl, git, mktemp
#
# Usage: $0 ${REMOTE_REPO}

default=git@github.com:tidepool-org/cluster-test1
remote=${1:-${REMOTE_REPO:-$default}}

if [ "$remote" == "$default" ]
then
	echo "must provide REMOTE_REPO, e.g. $default"
	#exit  1
fi

remotebase=$(basename $remote)

# create temporary workspace to clone Git repos into
mytmpdir=`mktemp -d 2>/dev/null || mktemp -d -t 'mytmpdir'`
cd $mytmpdir

# clone config repo
git clone $remote
cd $remotebase
CONFIG_DIR=$(realpath .)

CLUSTER_NAME=$(yq r $CONFIG_DIR/values.yaml cluster.metadata.name)
IAM_USERS=$(yq r $CONFIG_DIR/values.yaml aws.iamUsers | sed -e "s/- //")

# extract values to use for templating

# create cluster, install flux into cluster
echo "creating cluster"
eksctl create cluster -f $CONFIG_DIR/config.yaml

GROUP=system:masters

echo "adding system masters"
for user in ${IAM_USERS}
do
    echo "adding $user"
    arn=arn:aws:iam::${AWS_ACCOUNT}:user/${user}
    eksctl create iamidentitymapping --region=${AWS_REGION}  --role=$arn --group=$GROUP --name=${CLUSTER_NAME} --username=$user
done

rm -rf $mytmpdir

