#!/bin/bash 
#
# Create EKS cluster and install flux
#
# Requires config.yaml file in REMOTE_REPO.
#
# Depends on eksctl, git, mktemp
#
# Usage: $0 ${REMOTE_REPO}

red=`tput setaf 1`
green=`tput setaf 2`
magenta=`tput setaf 5`
reset=`tput sgr0`

REMOTE_REPO=${1:-$REMOTE_REPO}

if [ -z "$REMOTE_REPO" ]
then
        echo "${red}[x] must provide REMOTE_REPO${reset}"
        exit 1
fi

if [[ $REMOTE_REPO = git@github.com* ]]
then
        remote=$REMOTE_REPO
else
        remote="git@github.com:tidepool-org/$REMOTE_REPO"
fi

if [ -z "$GITHUB_TOKEN" ]
then
        echo "${red}[x] \$GITHUB_TOKEN required.${reset}"
        exit
fi

remotebase=$(basename $remote)

# create temporary workspace to clone Git repos into
mytmpdir=`mktemp -d 2>/dev/null || mktemp -d -t 'mytmpdir'`
trap "rm -rf $mytmpdir" EXIT
cd $mytmpdir

# clone config repo
git clone $remote
cd $remotebase
CONFIG_DIR=$(realpath .)

CLUSTER_NAME=$(yq r $CONFIG_DIR/values.yaml cluster.metadata.name)
IAM_USERS=$(yq r $CONFIG_DIR/values.yaml aws.iamUsers | sed -e "s/- //")
AWS_ACCOUNT=$(yq r $CONFIG_DIR/values.yaml aws.accountNumber | sed -e "s/- //")
kubeconfig=$(yq r $CONFIG_DIR/values.yaml kubeconfig | sed -e "s/- //")

if [ -z "$kubeconfig" -o  "$kubeconfig" == "null" ]
then
    kubeconfig=~/.kube/config
fi
kubeconfig=$(realpath $kubeconfig)

# extract values to use for templating

# create cluster, install flux into cluster
echo "${magenta}[√] creating cluster $CLUSTER_NAME${reset}"

localKubeConfig=$(realpath ./kubeconfig.yaml)
eksctl create cluster -f $CONFIG_DIR/config.yaml --kubeconfig $localKubeConfig
if [ $? -ne 0 ]
then
	exit 1
fi

if [ "$kubeconfig" != "$localKubeConfig" ]
then
    if [ -f $kubeconfig ]
    then
        echo "${magenta}[√] adding kubeconfig to $kubeconfig"
        KUBECONFIG=$kubeconfig:$localKubeConfig kubectl config view --flatten >updated.yaml
        mv updated.yaml $kubeconfig
    else
        mkdir -p $(dirname $kubeconfig)
        echo "${magenta}[√] creating $kubeconfig${reset}" 
        cp $localKubeConfig $kubeconfig
    fi
fi

git add .
git commit -m "Added kubeconfig file."
git push

make_users 

rm -rf $mytmpdir

