#!/bin/bash
#
# Create an Amazon EKS cluster using eksctl
#
# $0 

if [ -z "$CONFIG_FILE" ]
then
	echo "\$CONFIG_FILE required."
	exit
fi

if [ -z "$CLUSTER_NAME" ]
then
	echo "\$CLUSTER_NAME required."
	exit
fi

KIAM_ROLE_NAME=/clusters/${CLUSTER_NAME}/kiam-server-role

nodegroups=$(yq r ${CONFIG_FILE} nodeGroups[*].name | sed -e "s/- //"))
for nodegroup in $nodegroups
do
    update_kiam_server_role eksctl-${CLUSTER_NAME}-nodegroup-$nodegroup ${KIAM_ROLE_NAME}
done
