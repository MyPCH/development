#!/bin/bash
#
# Create an Amazon EKS cluster using eksctl
#
# $0 ${CLUSTER_NAME} ${CONFIG_FILE}



if [ $# == 0 ]
then
    YQ=yq
    CLUSTER_NAME=$(${YQ} r $CONFIG_FILE metadata.name)
else
    CLUSTER_NAME=$1
fi

#File in which cluster config is stored
CONFIG_FILE=${2:-config.yaml}

KIAM_ROLE_NAME=/clusters/${CLUSTER_NAME}/kiam-server-role

nodegroups=$(yq r ${CONFIG_FILE} nodeGroups[*].name | sed -e "s/- //"))
for nodegroup in $nodegroups
do
    update_kiam_server_role eksctl-${CLUSTER_NAME}-nodegroup-$nodegroup ${KIAM_ROLE_NAME}
done
