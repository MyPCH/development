#!/bin/bash
#
# Set IAM roles for Kiam
#
# Usage: $0 
#

if [ -z "$DEV_REPO" ]
then
	echo "\$DEV_REPO required."
	exit
fi

AWS_ACCOUNT=${AWS_ACCOUNT:-$(get_account)}
if [ -z "$AWS_ACCOUNT" ]
then
	echo "Must set \$AWS_ACCOUNT in enviroment"
	exit
fi
	
if [ -z "$AWS_REGION" ]
then
	echo "\$AWS_REGION required."
	exit
fi

if [ -z "$CLUSTER_NAME" ]
then
	echo "\$CLUSTER_NAME required."
	exit
fi

CF_FILE=file://${DEV_REPO}/cf/cluster-roles.yaml

NODEGROUP_STACK_NAME=eksctl-${CLUSTER_NAME}-nodegroup-ng-kiam

CLUSTER_STACK_NAME=eksctl-${CLUSTER_NAME}-roles

set -x
aws cloudformation create-stack --stack-name ${CLUSTER_STACK_NAME} --capabilities CAPABILITY_NAMED_IAM --template-body ${CF_FILE} --parameters ParameterKey=ClusterName,ParameterValue=${CLUSTER_NAME}     ParameterKey=NodeGroupStackName,ParameterValue=${NODEGROUP_STACK_NAME} ParameterKey=Region,ParameterValue=${AWS_REGION} ParameterKey=AccountNumber,ParameterValue=${AWS_ACCOUNT}
aws cloudformation wait stack-delete-complete --stack-name ${STACK_NAME}
