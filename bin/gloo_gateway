#!/bin/bash
rm -f $1/templates/gloo-*.yaml 

templates="$(helm template --namespace=default $1)"

if [ $? -eq 1 ]
then
	echo "helm template $1" failed
	echo "exiting without writing templates"
	exit 1
fi

echo "$templates" | mappings | gloo_manifests internal http | single_file "# Auto-generated file by $(basename $0). Do not edit.
{{- \$relname := .Release.Name -}}
" "" > $1/templates/gloo-internal.yaml

echo "$templates" | mappings | gloo_manifests external http | single_file "# Auto-generated file by $(basename $0). Do not edit.
{{ if and .Values.global.hosts.http .Values.gloabl.hosts.http.dnsNames }}
{{- range \$dnsName := .Values.global.hosts.http.dnsNames }}" "{{ end }}
{{ end }}" > $1/templates/gloo-external-http.yaml

echo "$templates" | mappings | gloo_manifests external https | single_file "# Auto-generated file by $(basename $0). Do not edit.
{{ if and .Values.global.hosts.https .Values.gloabl.hosts.https.dnsNames }}
{{- range \$dnsName := .Values.global.hosts.https.dnsNames }}" "{{ end }}
{{ end }}" > $1/templates/gloo-external-https.yaml
