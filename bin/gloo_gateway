#!/bin/bash
rm -f $1/templates/gloo-*.yaml 

templates="$(helm template --namespace=default $1)"

if [ $? -eq 1 ]
then
	echo "helm template $1" failed
	echo "exiting without writing templates"
	exit 1
fi

echo "$templates" | mappings | gloo_manifests internal http | single_file "# Auto-generated file by $(basename $0). Do not edit.
" "" > $1/templates/gloo-internal.yaml

echo "$templates" | mappings | gloo_manifests external http | single_file "# Auto-generated file by $(basename $0). Do not edit.
{{- range \$key, \$spec := .Values.global.hosts.http }}" "{{ end }}" > $1/templates/gloo-external-http.yaml

echo "$templates" | mappings | gloo_manifests external https | single_file "# Auto-generated file by $(basename $0). Do not edit.
{{- range \$key, \$spec := .Values.global.hosts.https }}" "{{ end }}" > $1/templates/gloo-external-https.yaml
