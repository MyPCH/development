#!/bin/bash -xv
# Install/upgrade Weave Flux
#
# If run within the a Git repo, it will use the remote origin repo as the source repo and the current branch as the source branch.

rp=$(git rev-parse --is-inside-work-tree 2>/dev/null)
if [ "${rp}" = "true" ]
then
    CURRENT_BRANCH=$(git branch | grep \* | cut -d ' ' -f2)
    CURRENT_REPO=$(git config --get remote.origin.url)
fi

CRDS_UNINSTALLED=$(kubectl get crds helmreleases.flux.weave.works >/dev/null; echo $?)
if [ ${CRDS_UNINSTALLED} -eq 0 ]
then
    INSTALL_CRDS=false
else
    INSTALL_CRDS=true
fi

BASE=$(git rev-parse --show-toplevel)/clusters/
CLUSTER_NAME=$(pwd | sed -e "s#^$BASE##" -e "s#/.*##")
CURRENT_PATH=clusters/${CLUSTER_NAME}

SOURCE_BRANCH=${2:-${CURRENT_BRANCH}}
SOURCE_PATH=${3:-${CURRENT_PATH}/flux}
SOURCE_REPO=${4:-${CURRENT_REPO}}
SOURCE_SECRET=${1:-${BASE}/${CLUSTER_NAME}/flux-secret.yaml}

GIT_SECRET_NAME=$(basename $SOURCE_SECRET | sed -e s/\.yaml$//)

if [ "$GIT_SECRET_NAME" != "flux-git-deploy" ]
then
	echo "applying secret for flux identity at ${SOURCE_SECRET}"
	kubectl apply -f ${SOURCE_SECRET}
fi

cd /tmp
rm -rf flux
git clone https://github.com/weaveworks/flux/
cd flux

read -p "Install weave: install_crds=${INSTALL_CRDS} branch=${SOURCE_BRANCH} path=${SOURCE_PATH} repo=${SOURCE_REPO}? (y|N)  " -n 1 -r
if [[ $REPLY =~ ^[Yy]$ ]]
then
    helm delete flux --purge
    helm upgrade \
    --install \
      --set rbac.create=true \
      --set helmOperator.create=true \
      --set helmOperator.chartsSyncInterval=1m \
      --set helmOperator.replicaCount=1 \
      --set helmOperator.updateChartDeps=true \
      --set helmOperator.createCRD=${INSTALL_CRDS} \
      --set git.secretName=${GIT_SECRET_NAME} \
      --set git.url=${SOURCE_REPO} \
      --set git.path=${SOURCE_PATH} \
      --set git.branch=${SOURCE_BRANCH} \
      --set git.pollInterval=1m \
      --set git.timeoout=40s \
      --namespace default \
      --reuse-values \
      --set additionalArgs='{--sync-garbage-collection,--connect=ws://fluxcloud}' \
      flux \
      chart/flux
else
	echo "No action taken."
fi
