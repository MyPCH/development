#!/bin/bash -xv

VALUES_FILE=${1:-values.yaml}

TO_HELMRELEASE_JSONNET=${DEV_REPO}/jsonnet/tidepool-helmreleases.jsonnet
TO_STRIPPED_HELMRELEASE_JSONNET=${DEV_REPO}/jsonnet/strip_secrets.jsonnet

#convert to JSON
export CONFIG_DATA=$(yq read -j $VALUES_FILE)

# create complete HelmReleases in a directory, with one file per helm release
mkdir -p out
jsonnet $TO_HELMRELEASE_JSONNET  --ext-code CONFIG_DATA="$CONFIG_DATA" -m out

# extract cluster name from input
CLUSTER_NAME=$(yq read $VALUES_FILE cluster.eks.name)

cd out
for HELMRELEASE in $(ls *.json)
do
	CONFIG_DATA=$(cat $HELMRELEASE)
	ENVIRONMENT=${HELMRELEASE%-helmrelease.json}
	mkdir -p $ENVIRONMENT
	jsonnet ${TO_STRIPPED_HELMRELEASE_JSONNET} --ext-code CONFIG_DATA="$CONFIG_DATA" >xx
       	yq read xx  >${ENVIRONMENT}/tidepool-helmrelease.yaml
	yq read $HELMRELEASE "spec.values" | generate_secrets $ENVIRONMENT | external_secret dryrun ${CLUSTER_NAME} encoded > ${ENVIRONMENT}/external-secrets.yaml
done
