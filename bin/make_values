#!/bin/bash
#
# Place starting values file in remote config repo.
#
# Usage: $0 ${REMOTE_REPO}

red=`tput setaf 1`
green=`tput setaf 2`
magenta=`tput setaf 5`
reset=`tput sgr0`

REMOTE_REPO=${1:-$REMOTE_REPO}

if [ -z "$GITHUB_TOKEN" ]
then
        echo "${red}[x] \$GITHUB_TOKEN required in environment.${reset}"
        exit 1
fi

if [ -z "$REMOTE_REPO" ]
then
        echo "${red}[x] must provide REMOTE_REPO in environment or as first argument.${reset}"
        exit 1
fi

if [[ $REMOTE_REPO = git@github.com* ]]
then
        remote=$REMOTE_REPO
else
        remote="git@github.com:tidepool-org/$REMOTE_REPO"
fi

echo "${magenta}[i] creating initial values file for repo $remote${reset}"

base=$(basename $remote)
mytmpdir=`mktemp -d 2>/dev/null || mktemp -d -t 'mytmpdir'`
cd $mytmpdir
trap "rm -rf $mytmpdir" EXIT
git clone git@github.com:tidepool-org/tidepool-quickstart
git clone $remote

if [ -f $base/values.yaml ]
then
	echo "${red}WARNING: will overwrite prior contents of values.yaml?${reset}"
        read -p "${red}Are you sure?${reset} " -n 1 -r
        if [[ ! $REPLY =~ ^[Yy]$ ]]
        then
                exit 1
        fi
fi
echo "${magenta}[i] creating values.yaml?${reset}"
cp tidepool-quickstart/values.yaml $base/
${EDITOR:-vi} $base/values.yaml
cd $base
git add .
git commit -m "Added values file."
git push
cd /
rm -rf $mytmpdir
echo "${magenta}[i] done${reset}"

