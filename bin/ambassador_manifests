#!/usr/local/bin/python3 
# Generate Ambassador CRDS from Mappings Annotations

import json
import os
import yaml
import sys

def manifests_from_mappings(mappings):
    """Generate Ambassador manifests."""
    result = dict()
    for mapping in mappings:
        mapping["host"] = "{{.Release.Namespace}}-" + ".tidepool.org|{{.Release.Namespace}}-" + "-internal"
        mapping["host_regex"] = True
        mapping["apiVersion"] = "getambassador.io/v1"
        mapping["service"] = mapping["service"].replace("default", "{{.Release.Namespace}}")
        mapping["name"] = mapping["name"].replace("default", "{{.Release.Namespace}}")
        result[mapping["name"]] = mapping
    return result

def write_manifests(manifests):
    print(yaml.dump(manifests, explicit_start = True, default_flow_style=False))

def main():
    write_manifests(manifests_from_mappings(yaml.safe_load(sys.stdin)))

if __name__ == "__main__":
    main()
