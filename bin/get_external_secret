#!/bin/bash 
#
# Get Secret from AWS Secrets Manager
#
# Usage: $0 $SECRET $ENVIRONMENT

if [ $# -ne 2 ]
then
	echo "Usage: $0 \$SECRET \$ENVIRONMENT
fi

SECRET=$1
ENVIRONMENT=$2

if [ -z "$CLUSTER_NAME" ]
then
    echo "\$CLUSTER_NAME required."
    exit
fi

out=$(aws secretsmanager get-secret-value  --secret-id ${CLUSTER_NAME}/${ENVIRONMENT}/${SECRET} | jq '.SecretString')

val=$(echo "echo $out" | bash)
yaml=$(python -c 'import sys, yaml, json; yaml.safe_dump(json.load(sys.stdin), sys.stdout, default_flow_style=False)' <<< $val)

indented=$(echo "$yaml" | sed -e 's/^/    /')

cat <<!
apiVersion: v1
kind: Secret
type: Opaque
data:
$indented
metadata:
  name: ${SECRET}
  namespace: ${ENVIRONMENT}
!
