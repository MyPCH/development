#!/bin/bash
#
# Apply update to IAM Role
#
# Usage: $0 ${STACK_NAME}

STACK_NAME=$1
current=$(aws cloudformation get-template --stack-name ${STACK_NAME})
read -r -d '' update << EOM
{ 
  "AssumeRolePolicyDocument": {
    "Statement": [
      {
        "Action": "sts:AssumeRole",
        "Effect": "Allow",
        "Principal": {
          "Service": "ec2.amazonaws.com"
        }
      }
    ],
    "Version": "2012-10-17"
  },
  "ManagedPolicyArns": [
    "arn:aws:iam::aws:policy/AmazonEKS_CNI_Policy",
    "arn:aws:iam::aws:policy/AmazonEKSWorkerNodePolicy",
    "arn:aws:iam::aws:policy/AmazonEC2ContainerRegistryFullAccess"
  ],
  "Path": "/"
}
EOM

TEMPLATE_BODY=$(echo "$current" | jq --argjson UPDATE "$update" '.TemplateBody.Resources.NodeInstanceRole.Properties |= $UPDATE' | jq .TemplateBody )

out=$(aws cloudformation create-change-set --capabilities CAPABILITY_IAM --region=us-west-2 --change-set-name update-policies --stack-name ${STACK_NAME} --template-body "$TEMPLATE_BODY" )

id=$(echo "$out" | jq .Id | sed -e s/\"//g)

aws cloudformation execute-change-set --change-set-name $id
