#!/usr/local/bin/python3
#
# Process Secrets CSV file into K8s Secrets
#
# Usage: $0 ${INPUT:-all-secrets}

import base64
import os

import yaml

INPUT=${1:-all-secrets}

with open($INPUT , 'r') as content_file:
    content = content_file.read()
    data=yaml.safe_load(content)
    for namespace, kinds in data.items():

        for kind, secrets in kinds.items():
            for name, data in secrets.items():
                secret = dict()
                if kind == "secret":
                    secret["kind"] = "Secret" 
                    secret["type"] = "Opaque"
                else: 
                    secret["kind"] =  "ConfigMap"
                secret["apiVersion"] = "v1"
                secret["metadata" ] = { "name" : name, "namespace" : namespace }
                secret["data"] = data
                dir = "secrets/" + namespace + "/" + kind
                os.makedirs(dir, exist_ok=True)
                filename = name + "-" + kind + ".yaml"
                with open(dir + "/" + filename, "w") as f:
                    output = yaml.dump(secret)
                    f.write(output)
