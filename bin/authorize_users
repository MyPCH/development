#!/bin/bash
#
# Install users as Kubernetes system masters
#
# Usage: $0 "${USERS}"

USERS=${1:-"lennartgoedhart-cli benderr-cli derrick-cli mikeallgeier-cli"}

# Create an Amazon EKS cluster using eksctl

# Amazon account number
AWS_ACCOUNT=${AWS_ACCOUNT:-$(get_account)}
if [ -z ${AWS_ACCOUNT+x} ]
then
	echo "\${AWS_ACCOUNT} must be set."
	exit 1
fi

# Users that will have system:master access (in addition to the user that creates the cluster)

CONFIG_FILE=${2:-config.yaml}

CLUSTER_NAME=$(yq r $CONFIG_FILE metadata.name)
REGION=$(yq r $CONFIG_FILE metadata.region)

# Kubernetes group to assign users to
GROUP=system:masters

for user in $USERS
do
    arn=arn:aws:iam::${AWS_ACCOUNT}:user/${user}
    eksctl create iamidentitymapping --region=${REGION}  --role=$arn --group=$GROUP --name=$CLUSTER_NAME --username=$user
done
