#!/bin/bash
#
# Create and config cluster to service Tidepool environments
#
# Usage: $0 ${VALUES_FILE:-values.yaml}

. set_exports $*

# create cluster
cd ${CLUSTER_REPO}
create_cluster 
sleep 600
STACK_NAME=eksctl-${CLUSTER_NAME}-cluster
aws cloudformation wait stack-delete-complete --stack-name $STACK_NAME
export KUBECONFIG=$(realpath ./kubeconfig.yaml)

# add authorized users
authorize_users "${USERS}"

# install tiller
install_tiller

# apply CRDS for cert-manager
kubectl apply -f https://raw.githubusercontent.com/jetstack/cert-manager/release-0.8/deploy/manifests/00-crds.yaml

# create IAM roles
cluster_roles
for ENVIRONMENT in ${ENVIRONMENTS}
do
  ENVIRONMENT=${ENVIRONMENT} env_roles
export

# add helm repos
kubectl apply -f flux-repositories.yaml

# install flux for GitOps
install_flux $FLUXCLOUD

# push deploy key to GitHub
push_deploy_key $GITHUB_ACCESS_TOKEN


