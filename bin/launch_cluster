#!/bin/bash
#
# Create and config cluster to service Tidepool environments
#
# Usage: $0
#
#    FLUXCLOUD

if [ -z "$KUBECONFIG" ]
then
	echo "\$KUBECONFIG required."
	exit
fi

if [ -z "$CLUSTER_DIR" ]
then
	echo "\$CLUSTER_DIR required."
	exit
fi

if [ -z "$CLUSTER_NAME" ]
then
	echo "\$CLUSTER_NAME required."
	exit
fi

if [ -z "$IAM_USERS" ]
then
	echo "\$IAM_USERS required."
	exit
fi

if [ -z "$GITHUB_TOKEN" ]
then
	echo "\$GITHUB_TOKEN required."
	exit
fi

export CLUSTER_STACK_NAME=eksctl-${CLUSTER_NAME}-cluster


# create cluster
cd ${CLUSTER_DIR}
create_cluster 
aws cloudformation wait stack-delete-complete --stack-name ${CLUSTER_STACK_NAME}

# add authorized users
authorize_users 

# install tiller
install_tiller

# apply CRDS for cert-manager
kubectl apply -f https://raw.githubusercontent.com/jetstack/cert-manager/release-0.8/deploy/manifests/00-crds.yaml

# create IAM roles
cluster_roles
env_roles 

# add helm repos
kubectl apply -f flux-repositories.yaml

# install flux for GitOps
install_flux 

# push deploy key to GitHub
push_deploy_key 


