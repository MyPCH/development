#!/bin/bash -xv
INFO=${1:-values.yaml}
export CONFIG_REPO=${2:-$(pwd)}
export CLUSTER_NAME=$(yq read $INFO global.cluster.name)
export AWS_REGION=$(yq read $INFO global.cluster.region)
export USERS=$(yq read values.yaml global.users | sed -e "s/^- //" | paste -sd " " -)
export ENVIRONMENTS=$(yq r values.yaml env | grep -v ' .*' | sed 's/.$//' | | paste -sd " " -)
export FLUXCLOUD=$(yq read $INFO global.fluxcloud.enabled)
export GITHUB_ACCESS_TOKEN=$(yq read $INFO global.github.token)

# create cluster
create_cluster
sleep 600
export KUBECONFIG=$(realpath ./kubeconfig.yaml)

# add authorized users
authorize_users "${USERS}"

# install tiller
install_tiller

# apply CRDS for cert-manager
kubectl apply -f https://raw.githubusercontent.com/jetstack/cert-manager/release-0.8/deploy/manifests/00-crds.yaml

# create IAM roles
cluster_roles
for ENVIRONMENT in ${ENVIRONMENTS}
do
  ENVIRONMENT=${ENVIRONMENT} env_roles
export

# add helm repos
kubectl apply -f flux-repositories.yaml

# install flux for GitOps
install_flux $FLUXCLOUD

# push deploy key to GitHub
push_deploy_key $GITHUB_ACCESS_TOKEN


