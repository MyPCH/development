#!/bin/bash -xv

. set_exports $*

# create cluster
create_cluster
sleep 600
export KUBECONFIG=$(realpath ./kubeconfig.yaml)

# add authorized users
authorize_users "${USERS}"

# install tiller
install_tiller

# apply CRDS for cert-manager
kubectl apply -f https://raw.githubusercontent.com/jetstack/cert-manager/release-0.8/deploy/manifests/00-crds.yaml

# create IAM roles
cluster_roles
for ENVIRONMENT in ${ENVIRONMENTS}
do
  ENVIRONMENT=${ENVIRONMENT} env_roles
export

# add helm repos
kubectl apply -f flux-repositories.yaml

# install flux for GitOps
install_flux $FLUXCLOUD

# push deploy key to GitHub
push_deploy_key $GITHUB_ACCESS_TOKEN


