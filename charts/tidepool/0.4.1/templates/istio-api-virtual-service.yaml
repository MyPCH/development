{{ if .Values.istio.gateway.enabled }}
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: api.{{- .Release.Namespace -}}.svc.cluster.local
  namespace: '{{- .Release.Namespace -}}'
spec:
  gateways:
  - primary-gateway
  - mesh
  hosts:
  - '{{- .Release.Namespace -}}-api.tidepool.org'
  - api-internal.{{- .Release.Namespace -}}.svc.cluster.local
  http:
  - corsPolicy:
      allowCredentials: true
      allowHeaders:
      - authorization
      - content-type
      - x-tidepool-session-token
      - x-tidepool-trace-request
      - x-tidepool-trace-session
      allowMethods:
      - GET
      - POST
      - PUT
      - PATCH
      - DELETE
      - OPTIONS
      allowOrigin:
      - '*'
      exposeHeaders:
      - x-tidepool-session-token
      - x-tidepool-trace-request
      - x-tidepool-trace-session
      maxAge: 300s
    match:
    - method:
        regex: GET|POST|DELETE
      uri:
        regex: /v1/users/[^/]+/restricted_tokens
    route:
    - destination:
        host: platform-auth.{{- .Release.Namespace -}}.svc.cluster.local
        port:
          number: 9222
  - corsPolicy:
      allowCredentials: true
      allowHeaders:
      - authorization
      - content-type
      - x-tidepool-session-token
      - x-tidepool-trace-request
      - x-tidepool-trace-session
      allowMethods:
      - GET
      - POST
      - PUT
      - PATCH
      - DELETE
      - OPTIONS
      allowOrigin:
      - '*'
      exposeHeaders:
      - x-tidepool-session-token
      - x-tidepool-trace-request
      - x-tidepool-trace-session
      maxAge: 300s
    match:
    - method:
        regex: GET|POST|DELETE
      uri:
        regex: /v1/users/[^/]+/provider_sessions
    route:
    - destination:
        host: platform-auth.{{- .Release.Namespace -}}.svc.cluster.local
        port:
          number: 9222
  - corsPolicy:
      allowCredentials: true
      allowHeaders:
      - authorization
      - content-type
      - x-tidepool-session-token
      - x-tidepool-trace-request
      - x-tidepool-trace-session
      allowMethods:
      - GET
      - POST
      - PUT
      - PATCH
      - DELETE
      - OPTIONS
      allowOrigin:
      - '*'
      exposeHeaders:
      - x-tidepool-session-token
      - x-tidepool-trace-request
      - x-tidepool-trace-session
      maxAge: 300s
    match:
    - method:
        regex: GET|POST|DELETE|OPTIONS
      uri:
        regex: /v1/users/[^/]+/data_sources
    route:
    - destination:
        host: platform-data.{{- .Release.Namespace -}}.svc.cluster.local
        port:
          number: 9220
  - corsPolicy:
      allowCredentials: true
      allowHeaders:
      - authorization
      - content-type
      - x-tidepool-session-token
      - x-tidepool-trace-request
      - x-tidepool-trace-session
      allowMethods:
      - GET
      - POST
      - PUT
      - PATCH
      - DELETE
      - OPTIONS
      allowOrigin:
      - '*'
      exposeHeaders:
      - x-tidepool-session-token
      - x-tidepool-trace-request
      - x-tidepool-trace-session
      maxAge: 300s
    match:
    - method:
        regex: GET|PUT|DELETE
      uri:
        regex: /v1/provider_sessions/[^/]+
    route:
    - destination:
        host: platform-auth.{{- .Release.Namespace -}}.svc.cluster.local
        port:
          number: 9222
  - corsPolicy:
      allowCredentials: true
      allowHeaders:
      - authorization
      - content-type
      - x-tidepool-session-token
      - x-tidepool-trace-request
      - x-tidepool-trace-session
      allowMethods:
      - GET
      - POST
      - PUT
      - PATCH
      - DELETE
      - OPTIONS
      allowOrigin:
      - '*'
      exposeHeaders:
      - x-tidepool-session-token
      - x-tidepool-trace-request
      - x-tidepool-trace-session
      maxAge: 300s
    match:
    - method:
        regex: GET|DELETE
      uri:
        regex: /v1/oauth/[^/]+/authorize
    route:
    - destination:
        host: platform-auth.{{- .Release.Namespace -}}.svc.cluster.local
        port:
          number: 9222
  - corsPolicy:
      allowCredentials: true
      allowHeaders:
      - authorization
      - content-type
      - x-tidepool-session-token
      - x-tidepool-trace-request
      - x-tidepool-trace-session
      allowMethods:
      - GET
      - POST
      - PUT
      - PATCH
      - DELETE
      - OPTIONS
      allowOrigin:
      - '*'
      exposeHeaders:
      - x-tidepool-session-token
      - x-tidepool-trace-request
      - x-tidepool-trace-session
      maxAge: 300s
    match:
    - method:
        exact: GET
      uri:
        regex: /v1/users/[^/]+/data_sets
    route:
    - destination:
        host: platform-data.{{- .Release.Namespace -}}.svc.cluster.local
        port:
          number: 9220
  - corsPolicy:
      allowCredentials: true
      allowHeaders:
      - authorization
      - content-type
      - x-tidepool-session-token
      - x-tidepool-trace-request
      - x-tidepool-trace-session
      allowMethods:
      - GET
      - POST
      - PUT
      - PATCH
      - DELETE
      - OPTIONS
      allowOrigin:
      - '*'
      exposeHeaders:
      - x-tidepool-session-token
      - x-tidepool-trace-request
      - x-tidepool-trace-session
      maxAge: 300s
    match:
    - method:
        regex: GET|POST|DELETE
      uri:
        regex: /v1/users/[^/]+/images/.+
    route:
    - destination:
        host: platform-image.{{- .Release.Namespace -}}.svc.cluster.local
        port:
          number: 9226
  - corsPolicy:
      allowCredentials: true
      allowHeaders:
      - authorization
      - content-type
      - x-tidepool-session-token
      - x-tidepool-trace-request
      - x-tidepool-trace-session
      allowMethods:
      - GET
      - POST
      - PUT
      - PATCH
      - DELETE
      - OPTIONS
      allowOrigin:
      - '*'
      exposeHeaders:
      - x-tidepool-session-token
      - x-tidepool-trace-request
      - x-tidepool-trace-session
      maxAge: 300s
    match:
    - method:
        exact: GET
      uri:
        regex: /v1/oauth/[^/]+/redirect
    route:
    - destination:
        host: platform-auth.{{- .Release.Namespace -}}.svc.cluster.local
        port:
          number: 9222
  - corsPolicy:
      allowCredentials: true
      allowHeaders:
      - authorization
      - content-type
      - x-tidepool-session-token
      - x-tidepool-trace-request
      - x-tidepool-trace-session
      allowMethods:
      - GET
      - POST
      - PUT
      - PATCH
      - DELETE
      - OPTIONS
      allowOrigin:
      - '*'
      exposeHeaders:
      - x-tidepool-session-token
      - x-tidepool-trace-request
      - x-tidepool-trace-session
      maxAge: 300s
    match:
    - method:
        regex: GET|POST
      uri:
        regex: /v1/users/[^/]+/datasets
    route:
    - destination:
        host: platform-data.{{- .Release.Namespace -}}.svc.cluster.local
        port:
          number: 9220
  - corsPolicy:
      allowCredentials: true
      allowHeaders:
      - authorization
      - content-type
      - x-tidepool-session-token
      - x-tidepool-trace-request
      - x-tidepool-trace-session
      allowMethods:
      - GET
      - POST
      - PUT
      - PATCH
      - DELETE
      - OPTIONS
      allowOrigin:
      - '*'
      exposeHeaders:
      - x-tidepool-session-token
      - x-tidepool-trace-request
      - x-tidepool-trace-session
      maxAge: 300s
    match:
    - method:
        exact: GET
      uri:
        regex: /v1/blobs/[^/]+/content
    route:
    - destination:
        host: platform-blob.{{- .Release.Namespace -}}.svc.cluster.local
        port:
          number: 9225
  - corsPolicy:
      allowCredentials: true
      allowHeaders:
      - authorization
      - content-type
      - x-tidepool-session-token
      - x-tidepool-trace-request
      - x-tidepool-trace-session
      allowMethods:
      - GET
      - POST
      - PUT
      - PATCH
      - DELETE
      - OPTIONS
      allowOrigin:
      - '*'
      exposeHeaders:
      - x-tidepool-session-token
      - x-tidepool-trace-request
      - x-tidepool-trace-session
      maxAge: 300s
    match:
    - method:
        regex: GET|PUT|DELETE
      uri:
        regex: /v1/data_sources/[^/]+
    route:
    - destination:
        host: platform-data.{{- .Release.Namespace -}}.svc.cluster.local
        port:
          number: 9220
  - corsPolicy:
      allowCredentials: true
      allowHeaders:
      - authorization
      - content-type
      - x-tidepool-session-token
      - x-tidepool-trace-request
      - x-tidepool-trace-session
      allowMethods:
      - GET
      - POST
      - PUT
      - PATCH
      - DELETE
      - OPTIONS
      allowOrigin:
      - '*'
      exposeHeaders:
      - x-tidepool-session-token
      - x-tidepool-trace-request
      - x-tidepool-trace-session
      maxAge: 300s
    match:
    - method:
        regex: GET|POST|DELETE
      uri:
        regex: /v1/users/[^/]+/images
    route:
    - destination:
        host: platform-image.{{- .Release.Namespace -}}.svc.cluster.local
        port:
          number: 9226
  - corsPolicy:
      allowCredentials: true
      allowHeaders:
      - authorization
      - content-type
      - x-tidepool-session-token
      - x-tidepool-trace-request
      - x-tidepool-trace-session
      allowMethods:
      - GET
      - POST
      - PUT
      - PATCH
      - DELETE
      - OPTIONS
      allowOrigin:
      - '*'
      exposeHeaders:
      - x-tidepool-session-token
      - x-tidepool-trace-request
      - x-tidepool-trace-session
      maxAge: 300s
    match:
    - method:
        regex: GET|PUT|DELETE
      uri:
        prefix: /v1/restricted_tokens
    route:
    - destination:
        host: platform-auth.{{- .Release.Namespace -}}.svc.cluster.local
        port:
          number: 9222
  - corsPolicy:
      allowCredentials: true
      allowHeaders:
      - authorization
      - content-type
      - x-tidepool-session-token
      - x-tidepool-trace-request
      - x-tidepool-trace-session
      allowMethods:
      - GET
      - POST
      - PUT
      - PATCH
      - DELETE
      - OPTIONS
      allowOrigin:
      - '*'
      exposeHeaders:
      - x-tidepool-session-token
      - x-tidepool-trace-request
      - x-tidepool-trace-session
      maxAge: 300s
    match:
    - method:
        regex: GET|POST|DELETE
      uri:
        regex: /v1/users/[^/]+/blobs
    route:
    - destination:
        host: platform-blob.{{- .Release.Namespace -}}.svc.cluster.local
        port:
          number: 9225
  - corsPolicy:
      allowCredentials: true
      allowHeaders:
      - authorization
      - content-type
      - x-tidepool-session-token
      - x-tidepool-trace-request
      - x-tidepool-trace-session
      allowMethods:
      - GET
      - POST
      - PUT
      - PATCH
      - DELETE
      - OPTIONS
      allowOrigin:
      - '*'
      exposeHeaders:
      - x-tidepool-session-token
      - x-tidepool-trace-request
      - x-tidepool-trace-session
      maxAge: 300s
    match:
    - method:
        exact: DELETE
      uri:
        regex: /v1/users/[^/]+/data
    route:
    - destination:
        host: platform-data.{{- .Release.Namespace -}}.svc.cluster.local
        port:
          number: 9220
  - corsPolicy:
      allowCredentials: true
      allowHeaders:
      - authorization
      - content-type
      - x-tidepool-session-token
      - x-tidepool-trace-request
      - x-tidepool-trace-session
      allowMethods:
      - GET
      - POST
      - PUT
      - PATCH
      - DELETE
      - OPTIONS
      allowOrigin:
      - '*'
      exposeHeaders:
      - x-tidepool-session-token
      - x-tidepool-trace-request
      - x-tidepool-trace-session
      maxAge: 300s
    match:
    - method:
        regex: GET|DELETE
      uri:
        regex: /v1/blobs/[^/]+
    route:
    - destination:
        host: platform-blob.{{- .Release.Namespace -}}.svc.cluster.local
        port:
          number: 9225
  - corsPolicy:
      allowCredentials: true
      allowHeaders:
      - authorization
      - content-type
      - x-tidepool-session-token
      - x-tidepool-trace-request
      - x-tidepool-trace-session
      allowMethods:
      - GET
      - POST
      - PUT
      - PATCH
      - DELETE
      - OPTIONS
      allowOrigin:
      - '*'
      exposeHeaders:
      - x-tidepool-session-token
      - x-tidepool-trace-request
      - x-tidepool-trace-session
      maxAge: 300s
    match:
    - method:
        regex: GET|PUT|DELETE
      uri:
        regex: /v1/tasks/[^/*]
    route:
    - destination:
        host: platform-task.{{- .Release.Namespace -}}.svc.cluster.local
        port:
          number: 9224
  - corsPolicy:
      allowCredentials: true
      allowHeaders:
      - authorization
      - content-type
      - x-tidepool-session-token
      - x-tidepool-trace-request
      - x-tidepool-trace-session
      allowMethods:
      - GET
      - POST
      - PUT
      - PATCH
      - DELETE
      - OPTIONS
      allowOrigin:
      - '*'
      exposeHeaders:
      - x-tidepool-session-token
      - x-tidepool-trace-request
      - x-tidepool-trace-session
      maxAge: 300s
    match:
    - method:
        regex: GET|DELETE
      uri:
        regex: /v1/users/[^/*]
    route:
    - destination:
        host: platform-user.{{- .Release.Namespace -}}.svc.cluster.local
        port:
          number: 9221
  - corsPolicy:
      allowCredentials: true
      allowHeaders:
      - authorization
      - content-type
      - x-tidepool-session-token
      - x-tidepool-trace-request
      - x-tidepool-trace-session
      allowMethods:
      - GET
      - POST
      - PUT
      - PATCH
      - DELETE
      - OPTIONS
      allowOrigin:
      - '*'
      exposeHeaders:
      - x-tidepool-session-token
      - x-tidepool-trace-request
      - x-tidepool-trace-session
      maxAge: 300s
    match:
    - method:
        regex: GET|OPTIONS|POST|PUT|PATCH|DELETE
      uri:
        prefix: /dataservices/
    rewrite:
      uri: /
    route:
    - destination:
        host: platform-data.{{- .Release.Namespace -}}.svc.cluster.local
        port:
          number: 9220
  - corsPolicy:
      allowCredentials: true
      allowHeaders:
      - authorization
      - content-type
      - x-tidepool-session-token
      - x-tidepool-trace-request
      - x-tidepool-trace-session
      allowMethods:
      - GET
      - POST
      - PUT
      - PATCH
      - DELETE
      - OPTIONS
      allowOrigin:
      - '*'
      exposeHeaders:
      - x-tidepool-session-token
      - x-tidepool-trace-request
      - x-tidepool-trace-session
      maxAge: 300s
    match:
    - method:
        regex: GET|OPTIONS|POST|PUT|PATCH|DELETE
      uri:
        prefix: /userservices/
    rewrite:
      uri: /
    route:
    - destination:
        host: platform-user.{{- .Release.Namespace -}}.svc.cluster.local
        port:
          number: 9221
  - corsPolicy:
      allowCredentials: true
      allowHeaders:
      - authorization
      - content-type
      - x-tidepool-session-token
      - x-tidepool-trace-request
      - x-tidepool-trace-session
      allowMethods:
      - GET
      - POST
      - PUT
      - PATCH
      - DELETE
      - OPTIONS
      allowOrigin:
      - '*'
      exposeHeaders:
      - x-tidepool-session-token
      - x-tidepool-trace-request
      - x-tidepool-trace-session
      maxAge: 300s
    match:
    - method:
        exact: GET
      uri:
        prefix: /v1/data_sets
    route:
    - destination:
        host: platform-data.{{- .Release.Namespace -}}.svc.cluster.local
        port:
          number: 9220
  - corsPolicy:
      allowCredentials: true
      allowHeaders:
      - authorization
      - content-type
      - x-tidepool-session-token
      - x-tidepool-trace-request
      - x-tidepool-trace-session
      allowMethods:
      - GET
      - POST
      - PUT
      - PATCH
      - DELETE
      - OPTIONS
      allowOrigin:
      - '*'
      exposeHeaders:
      - x-tidepool-session-token
      - x-tidepool-trace-request
      - x-tidepool-trace-session
      maxAge: 300s
    match:
    - method:
        regex: POST|PUT|DELETE
      uri:
        prefix: /v1/datasets
    route:
    - destination:
        host: platform-data.{{- .Release.Namespace -}}.svc.cluster.local
        port:
          number: 9220
  - corsPolicy:
      allowCredentials: true
      allowHeaders:
      - authorization
      - content-type
      - x-tidepool-session-token
      - x-tidepool-trace-request
      - x-tidepool-trace-session
      allowMethods:
      - GET
      - POST
      - PUT
      - PATCH
      - DELETE
      - OPTIONS
      allowOrigin:
      - '*'
      exposeHeaders:
      - x-tidepool-session-token
      - x-tidepool-trace-request
      - x-tidepool-trace-session
      maxAge: 300s
    match:
    - method:
        regex: GET|PUT|DELETE
      uri:
        prefix: /v1/images
    route:
    - destination:
        host: platform-image.{{- .Release.Namespace -}}.svc.cluster.local
        port:
          number: 9226
  - corsPolicy:
      allowCredentials: true
      allowHeaders:
      - authorization
      - content-type
      - x-tidepool-session-token
      - x-tidepool-trace-request
      - x-tidepool-trace-session
      allowMethods:
      - GET
      - POST
      - PUT
      - PATCH
      - DELETE
      - OPTIONS
      allowOrigin:
      - '*'
      exposeHeaders:
      - x-tidepool-session-token
      - x-tidepool-trace-request
      - x-tidepool-trace-session
      maxAge: 300s
    match:
    - method:
        regex: GET|OPTIONS|POST|PUT|PATCH|DELETE
      uri:
        prefix: /metadata/
    rewrite:
      uri: /
    route:
    - destination:
        host: seagull.{{- .Release.Namespace -}}.svc.cluster.local
        port:
          number: 9120
  - corsPolicy:
      allowCredentials: true
      allowHeaders:
      - authorization
      - content-type
      - x-tidepool-session-token
      - x-tidepool-trace-request
      - x-tidepool-trace-session
      allowMethods:
      - GET
      - POST
      - PUT
      - PATCH
      - DELETE
      - OPTIONS
      allowOrigin:
      - '*'
      exposeHeaders:
      - x-tidepool-session-token
      - x-tidepool-trace-request
      - x-tidepool-trace-session
      maxAge: 300s
    match:
    - method:
        regex: GET|OPTIONS|POST|PUT|PATCH|DELETE
      uri:
        prefix: /metrics/
    rewrite:
      uri: /
    route:
    - destination:
        host: highwater.{{- .Release.Namespace -}}.svc.cluster.local
        port:
          number: 9191
  - corsPolicy:
      allowCredentials: true
      allowHeaders:
      - authorization
      - content-type
      - x-tidepool-session-token
      - x-tidepool-trace-request
      - x-tidepool-trace-session
      allowMethods:
      - GET
      - POST
      - PUT
      - PATCH
      - DELETE
      - OPTIONS
      allowOrigin:
      - '*'
      exposeHeaders:
      - x-tidepool-session-token
      - x-tidepool-trace-request
      - x-tidepool-trace-session
      maxAge: 300s
    match:
    - method:
        regex: GET|OPTIONS|POST|PUT|PATCH|DELETE
      uri:
        prefix: /confirm/
    rewrite:
      uri: /
    route:
    - destination:
        host: hydrophone.{{- .Release.Namespace -}}.svc.cluster.local
        port:
          number: 9157
  - corsPolicy:
      allowCredentials: true
      allowHeaders:
      - authorization
      - content-type
      - x-tidepool-session-token
      - x-tidepool-trace-request
      - x-tidepool-trace-session
      allowMethods:
      - GET
      - POST
      - PUT
      - PATCH
      - DELETE
      - OPTIONS
      allowOrigin:
      - '*'
      exposeHeaders:
      - x-tidepool-session-token
      - x-tidepool-trace-request
      - x-tidepool-trace-session
      maxAge: 300s
    match:
    - method:
        regex: GET|OPTIONS|POST|PUT|PATCH|DELETE
      uri:
        prefix: /message/
    rewrite:
      uri: /
    route:
    - destination:
        host: message-api.{{- .Release.Namespace -}}.svc.cluster.local
        port:
          number: 9119
  - corsPolicy:
      allowCredentials: true
      allowHeaders:
      - authorization
      - content-type
      - x-tidepool-session-token
      - x-tidepool-trace-request
      - x-tidepool-trace-session
      allowMethods:
      - GET
      - POST
      - PUT
      - PATCH
      - DELETE
      - OPTIONS
      allowOrigin:
      - '*'
      exposeHeaders:
      - x-tidepool-session-token
      - x-tidepool-trace-request
      - x-tidepool-trace-session
      maxAge: 300s
    match:
    - method:
        regex: GET|OPTIONS|POST|PUT|PATCH|DELETE
      uri:
        prefix: /v1/data/
    rewrite:
      uri: /
    route:
    - destination:
        host: platform-data.{{- .Release.Namespace -}}.svc.cluster.local
        port:
          number: 9220
  - corsPolicy:
      allowCredentials: true
      allowHeaders:
      - authorization
      - content-type
      - x-tidepool-session-token
      - x-tidepool-trace-request
      - x-tidepool-trace-session
      allowMethods:
      - GET
      - POST
      - PUT
      - PATCH
      - DELETE
      - OPTIONS
      allowOrigin:
      - '*'
      exposeHeaders:
      - x-tidepool-session-token
      - x-tidepool-trace-request
      - x-tidepool-trace-session
      maxAge: 300s
    match:
    - method:
        regex: GET|POST
      uri:
        prefix: /v1/tasks
    route:
    - destination:
        host: platform-task.{{- .Release.Namespace -}}.svc.cluster.local
        port:
          number: 9224
  - corsPolicy:
      allowCredentials: true
      allowHeaders:
      - authorization
      - content-type
      - x-tidepool-session-token
      - x-tidepool-trace-request
      - x-tidepool-trace-session
      allowMethods:
      - GET
      - POST
      - PUT
      - PATCH
      - DELETE
      - OPTIONS
      allowOrigin:
      - '*'
      exposeHeaders:
      - x-tidepool-session-token
      - x-tidepool-trace-request
      - x-tidepool-trace-session
      maxAge: 300s
    match:
    - method:
        regex: GET|OPTIONS|POST|PUT|PATCH|DELETE
      uri:
        prefix: /export/
    rewrite:
      uri: /
    route:
    - destination:
        host: export.{{- .Release.Namespace -}}.svc.cluster.local
        port:
          number: 9300
  - corsPolicy:
      allowCredentials: true
      allowHeaders:
      - authorization
      - content-type
      - x-tidepool-session-token
      - x-tidepool-trace-request
      - x-tidepool-trace-session
      allowMethods:
      - GET
      - POST
      - PUT
      - PATCH
      - DELETE
      - OPTIONS
      allowOrigin:
      - '*'
      exposeHeaders:
      - x-tidepool-session-token
      - x-tidepool-trace-request
      - x-tidepool-trace-session
      maxAge: 300s
    match:
    - method:
        regex: GET|OPTIONS|POST|PUT|PATCH|DELETE
      uri:
        prefix: /access/
    route:
    - destination:
        host: gatekeeper.{{- .Release.Namespace -}}.svc.cluster.local
        port:
          number: 9123
  - corsPolicy:
      allowCredentials: true
      allowHeaders:
      - authorization
      - content-type
      - x-tidepool-session-token
      - x-tidepool-trace-request
      - x-tidepool-trace-session
      allowMethods:
      - GET
      - POST
      - PUT
      - PATCH
      - DELETE
      - OPTIONS
      allowOrigin:
      - '*'
      exposeHeaders:
      - x-tidepool-session-token
      - x-tidepool-trace-request
      - x-tidepool-trace-session
      maxAge: 300s
    match:
    - method:
        exact: GET
      uri:
        prefix: /v1/time
    route:
    - destination:
        host: platform-data.{{- .Release.Namespace -}}.svc.cluster.local
        port:
          number: 9220
  - corsPolicy:
      allowCredentials: true
      allowHeaders:
      - authorization
      - content-type
      - x-tidepool-session-token
      - x-tidepool-trace-request
      - x-tidepool-trace-session
      allowMethods:
      - GET
      - POST
      - PUT
      - PATCH
      - DELETE
      - OPTIONS
      allowOrigin:
      - '*'
      exposeHeaders:
      - x-tidepool-session-token
      - x-tidepool-trace-request
      - x-tidepool-trace-session
      maxAge: 300s
    match:
    - method:
        regex: GET|OPTIONS|POST|PUT|PATCH|DELETE
      uri:
        prefix: /auth/
    rewrite:
      uri: /
    route:
    - destination:
        host: shoreline.{{- .Release.Namespace -}}.svc.cluster.local
        port:
          number: 9107
  - corsPolicy:
      allowCredentials: true
      allowHeaders:
      - authorization
      - content-type
      - x-tidepool-session-token
      - x-tidepool-trace-request
      - x-tidepool-trace-session
      allowMethods:
      - GET
      - POST
      - PUT
      - PATCH
      - DELETE
      - OPTIONS
      allowOrigin:
      - '*'
      exposeHeaders:
      - x-tidepool-session-token
      - x-tidepool-trace-request
      - x-tidepool-trace-session
      maxAge: 300s
    match:
    - method:
        regex: GET|OPTIONS|POST|PUT|PATCH|DELETE
      uri:
        prefix: /data/
    rewrite:
      uri: /
    route:
    - destination:
        host: tide-whisperer.{{- .Release.Namespace -}}.svc.cluster.local
        port:
          number: 9127
{{ end }}
