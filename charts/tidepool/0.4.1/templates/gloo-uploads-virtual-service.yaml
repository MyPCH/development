{{ if .Values.gloo.enabled }}
apiVersion: gateway.solo.io/v1
kind: VirtualService
metadata:
  name: uploads-vs-{{.Release.Namespace}}
  namespace: gloo-system
spec:
{{ if .Values.usessl }}
  sslConfig:
    sniDomains:
    - {{ include "charts.host.uploads" . }}
    secretRef: 
      name: tidepool-org
      namespace: gloo-system
{{ end }}
  virtualHost:
    corsPolicy:
      allowCredentials: true
      allowHeaders:
      - authorization
      - content-type
      - x-tidepool-session-token
      - x-tidepool-trace-request
      - x-tidepool-trace-session
      allowMethods:
      - GET
      - POST
      - PUT
      - PATCH
      - DELETE
      allowOriginRegex:
      - '*'
      exposeHeaders:
      - x-tidepool-session-token
      - x-tidepool-trace-request
      - x-tidepool-trace-session
      maxAge: 0
    domains: 
    - {{ include "charts.host.uploads" . }}
    name: uploads.gloo-system.{{.Release.Namespace}}
    routes:
    - matcher:
        prefix: /
      routeAction:
        single:
          upstream:
            name: {{.Release.Namespace}}-jellyfish-{{ .Values.jellyfish.port }}
            namespace: gloo-system
 {{ end }}
