{{ if .Values.istio.gateway.enabled }}
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: uploads.{{- .Release.Namespace -}}.svc.cluster.local
  namespace: '{{- .Release.Namespace -}}'
spec:
  gateways:
  - primary-gateway
  - mesh
  hosts:
  - '{{- .Release.Namespace -}}-uploads.tidepool.org'
  - styx.{{- .Release.Namespace -}}.svc.cluster.local
  http:
  - corsPolicy:
      allowCredentials: true
      allowHeaders:
      - authorization
      - content-type
      - x-tidepool-session-token
      - x-tidepool-trace-request
      - x-tidepool-trace-session
      allowMethods:
      - GET
      - POST
      - PUT
      - PATCH
      - DELETE
      - OPTIONS
      allowOrigin:
      - '*'
      exposeHeaders:
      - x-tidepool-session-token
      - x-tidepool-trace-request
      - x-tidepool-trace-session
      maxAge: 300s
    match:
    - method:
        regex: GET|OPTIONS|POST|PUT|PATCH|DELETE
      uri:
        prefix: /
    route:
    - destination:
        host: jellyfish.{{- .Release.Namespace -}}.svc.cluster.local
        port:
          number: 9122
{{ end }}
