{{- if .Values.gloo.enabled -}}
apiVersion: gateway.solo.io/v1
kind: VirtualService
metadata:
  name: '{{.Release.Namespace}}-app.tidepool.org'
  namespace: '{{- .Release.Namespace -}}'
spec:
  sslConfig:
    secretRef:
      name: tidepool-org
      namespace: default
    sniDomains:
    - '{{.Release.Namespace}}-app.tidepool.org'
  virtualHost:
    corsPolicy:
      allowCredentials: true
      allowHeaders:
      - authorization
      - content-type
      - x-tidepool-session-token
      - x-tidepool-trace-request
      - x-tidepool-trace-session
      allowMethods:
      - GET
      - POST
      - PUT
      - PATCH
      - DELETE
      - OPTIONS
      allowOriginRegex:
      - '*'
      exposeHeaders:
      - x-tidepool-session-token
      - x-tidepool-trace-request
      - x-tidepool-trace-session
      maxAge: 300s
    domains:
    - '{{.Release.Namespace}}-app.tidepool.org'
    name: '{{.Release.Namespace}}-app.tidepool.org'
    routes:
    - matcher:
        methods:
        - GET
        - OPTIONS
        - POST
        - PUT
        - PATCH
        - DELETE
        prefix: /
      routeAction:
        single:
          upstream:
            name: '{{- .Release.Namespace -}}-blip-3000'
            namespace: '{{- .Release.Namespace -}}'
{{- end -}}
