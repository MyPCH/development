{{ if .Values.gloo.generate.gateways }}
apiVersion: gateway.solo.io/v1
kind: Gateway
metadata:
  annotations:
    origin: default
  name: gateway-proxy-ssl
  namespace: {{ .Values.ingress.deployment.namespace | default "gloo-system" }}
spec:
  bindAddress: '::'
  bindPort: 8443
  httpGateway:
    options:
      healthCheck:
        path: /status
      httpConnectionManagerSettings:
        tracing:
          requestHeadersForTags:
          - path
          - origin
          verbose: true
        useRemoteAddress: true
    virtualServiceNamespaces:
    - '*'
    virtualServiceSelector:
      protocol: https
      type: external
  proxyNames:
  - gateway-proxy
  ssl: true
  useProxyProto: {{ .Values.global.gateway.proxyProtocol }}
  options:
    accessLoggingService:
      accessLog:
      - fileSink:
          jsonFormat:
            authority: '%REQ(:authority)%'
            authorization: '%REQ(authorization)%'
            content: '%REQ(content-type)%'
            duration: '%DURATION%'
            forwardedFor: '%REQ(X-FORWARDED-FOR)%'
            method: '%REQ(:method)%'
            path: '%REQ(:path)%'
            remoteAddress: '%DOWNSTREAM_REMOTE_ADDRESS_WITHOUT_PORT%'
            request: '%REQ(x-tidepool-trace-request)%'
            response: '%RESPONSE_CODE%'
            scheme: '%REQ(:scheme)%'
            session: '%REQ(x-tidepool-trace-session)%'
            startTime: '%START_TIME%'
            token: '%REQ(x-tidepool-session-token)%'
            upstream: '%UPSTREAM_CLUSTER%'
          path: /dev/stdout
{{- end }}
