{{ $spec := .Values.gateway.gatewayProxy }}
{{ if $spec.enabled }}
apiVersion: gateway.solo.io/v1
kind: Gateway
metadata:
  annotations:
    origin: default
  name: gateway-proxy
  namespace: {{ .Release.Namespace }}
spec:
  bindAddress: '::'
  bindPort: 8080
  httpGateway:
    options:
      healthCheck:
        path: /status
      httpConnectionManagerSettings:
        tracing:
          requestHeadersForTags:
          - path
          - origin
          verbose: true
        useRemoteAddress: true
    virtualServiceSelector:
    {{- range $key, $value := $spec.labels }}
      {{ $key }}: {{ $value | quote }}
    {{- end }}
  options:
    accessLoggingService:
      accessLog:
      - fileSink:
          jsonFormat:
            authority: '%REQ(:authority)%'
            authorization: '%REQ(authorization)%'
            content: '%REQ(content-type)%'
            duration: '%DURATION%'
            forwardedFor: '%REQ(X-FORWARDED-FOR)%'
            method: '%REQ(:method)%'
            path: '%REQ(:path)%'
            remoteAddress: '%DOWNSTREAM_REMOTE_ADDRESS_WITHOUT_PORT%'
            request: '%REQ(x-tidepool-trace-request)%'
            response: '%RESPONSE_CODE%'
            scheme: '%REQ(:scheme)%'
            session: '%REQ(x-tidepool-trace-session)%'
            startTime: '%START_TIME%'
            token: '%REQ(x-tidepool-session-token)%'
            upstream: '%UPSTREAM_CLUSTER%'
          path: /dev/stdout
  proxyNames:
  - {{ $spec.proxy.name }}
  useProxyProto: {{ $spec.proxyProtocol }}
{{- end }}
