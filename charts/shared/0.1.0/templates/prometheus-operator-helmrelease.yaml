{{ if .Values.prometheusOperator.helmrelease.create }}
---
apiVersion: flux.weave.works/v1beta1
kind: HelmRelease
metadata:
  name: prometheus-operator
  namespace: {{ .Values.prometheusOperator.namespace.name }}
spec:
  releaseName: prometheus-operator
  chart:
    {{- .Values.prometheusOperator.helmrelease.chart | toYaml | nindent 4 }}
  values:
    prometheus:
      prometheusSpec:
        replicas: {{ .Values.prometheus.deployment.replicaCount }}      # work in High-Availability mode
        retention: "{{ .Values.prometheus.deployment.env.retention }}"    # we only need a few hours of retention, since the rest is uploaded to blob
        image:
          tag: "{{ .Values.prometheus.deployment.tag }}"     # use a specific version of Prometheus
        externalLabels:  # a cool way to add default labels to all metrics 
          geo: us          
          region: {{ .Values.cluster.eks.region | quote }}
        serviceMonitorNamespaceSelector:  # allows the operator to find target config from multiple namespaces
          any: true
        thanos:         # add Thanos Sidecar
          tag: "{{ .Values.thanos.deployment.tag }}"    # a specific version of Thanos
          objectStorageConfig: # blob storage configuration to upload metrics 
            key: thanos.yaml
            name: {{ .Values.thanos.secret.name }}
    grafana:           # (optional) we don't need Grafana in all clusters
      helmrelease:
        create: false
{{ end }}
