{{ if .Values.gloo.helmrelease.create }}
---
apiVersion: flux.weave.works/v1beta1
kind: HelmRelease
metadata:
  name: gloo
  namespace: {{ .Values.gloo.namespace.name }}
  annotations:
    flux.weave.works/automated: "false"
spec:
  releaseName: gloo
  chart:
    {{- .Values.gloo.helmrelease.chart | toYaml | nindent 4 }}
  values:
    crds:
      create: {{ .Values.gloo.crds.create }}
    settings:
      create: true
    discovery:
      fdsMode: "WHITELIST"
    gatewayProxies:
      gatewayProxyV2:
        service:
          extraAnnotations:
            service.beta.kubernetes.io/aws-load-balancer-type: "nlb"
            external-dns.alpha.kubernetes.io/alias: "true"
            external-dns.alpha.kubernetes.io/hostname: {{ join "," .Values.gloo.gatewayProxy.hostnames | quote }}
            service.beta.kubernetes.io/aws-load-balancer-additional-resource-tags: {{ printf "cluster:%s" .Values.cluster.eks.name | quote }}
{{ end }}
