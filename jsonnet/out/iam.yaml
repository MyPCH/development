apiVersion: tidepool/v1beta1
data:
  AWSTemplateFormatVersion: "2010-09-09"
  Description: Cluster development
  Resources:
    AutoscalerAWSIAMManagedPolicy:
      Properties:
        PolicyDocument:
          Statement:
          - Action:
            - autoscaling:DescribeAutoScalingInstances
            - autoscaling:SetDesiredCapacity
            - autoscaling:DescribeAutoScalingGroups
            - autoscaling:DescribeTags
            - autoscaling:DescribeLaunchConfigurations
            - autoscaling:TerminateInstanceInAutoScalingGroup
            Effect: Allow
            Resource: '*'
          Version: "2012-10-17"
      Type: AWS::IAM::ManagedPolicy
    AutoscalerAWSIAMRole:
      Properties:
        AssumeRolePolicyDocument:
          Statement:
          - Action: sts:AssumeRole
            Effect: Allow
            Principal:
              Service: ec2.amazonaws.com
          - Action: sts:AssumeRole
            Effect: Allow
            Principal:
              AWS:
                Fn::GetAtt:
                - KiamAWSIAMRole
                - Arn
          Version: "2012-10-17"
        ManagedPolicyArns:
        - Ref: AutoscalerAWSIAMManagedPolicy
        RoleName: development-autoscaler-role
      Type: AWS::IAM::Role
    CertManagerAWSIAMManagedPolicy:
      Properties:
        PolicyDocument:
          Statement:
          - Action: route53:ChangeResourceRecordSets
            Effect: Allow
            Resource: arn:aws:route53:::hostedzone/*
          - Action:
            - route53:GetChange
            - route53:ListHostedZones
            - route53:ListResourceRecordSets
            - route53:ListHostedZonesByName
            Effect: Allow
            Resource: '*'
          Version: "2012-10-17"
      Type: AWS::IAM::ManagedPolicy
    CertManagerAWSIAMRole:
      Properties:
        AssumeRolePolicyDocument:
          Statement:
          - Action: sts:AssumeRole
            Effect: Allow
            Principal:
              Service: ec2.amazonaws.com
          - Action: sts:AssumeRole
            Effect: Allow
            Principal:
              AWS:
                Fn::GetAtt:
                - KiamAWSIAMRole
                - Arn
          Version: "2012-10-17"
        ManagedPolicyArns:
        - Ref: CertManagerAWSIAMManagedPolicy
        RoleName: development-cert-manager-role
      Type: AWS::IAM::Role
    DefaultAWSIAMManagedPolicy:
      Properties:
        PolicyDocument:
          Version: "2012-10-17"
        Statements:
        - Action: s3:ListBucket
          Effect: Allow
          Resource:
          - arn:aws:s3:::tidepool-development-default-data/*
        - Action:
          - s3:GetObject
          - s3:PutObject
          - s3:DeleteObject
          Effect: Allow
          Resource:
          - arn:aws:s3:::tidepool-development-default-data/*
        - Action: ses:*
          Effect: Allow
          Resource: '*'
      Type: AWS::IAM::ManagedPolicy
    DefaultAWSIAMRole:
      Properties:
        AssumeRolePolicyDocument:
          Statement:
          - Action: sts:AssumeRole
            Effect: Allow
            Principal:
              Service: ec2.amazonaws.com
          - Action: sts:AssumeRole
            Effect: Allow
            Principal:
              AWS:
                Fn::GetAtt:
                - KiamAWSIAMRole
                - Arn
          Version: "2012-10-17"
        ManagedPolicyArns:
        - Ref: DefaultAWSIAMManagedPolicy
        RoleName: development-default-role
      Type: AWS::IAM::Role
    ExternalDnsAWSIAMManagedPolicy:
      Properties:
        PolicyDocument:
          Statement:
          - Action: route53:ChangeResourceRecordSets
            Effect: Allow
            Resource: arn:aws:route53:::hostedzone/*
          - Action:
            - route53:GetChange
            - route53:ListHostedZones
            - route53:ListResourceRecordSets
            - route53:ListHostedZonesByName
            Effect: Allow
            Resource: '*'
          Version: "2012-10-17"
      Type: AWS::IAM::ManagedPolicy
    ExternalDnsAWSIAMRole:
      Properties:
        AssumeRolePolicyDocument:
          Statement:
          - Action: sts:AssumeRole
            Effect: Allow
            Principal:
              Service: ec2.amazonaws.com
          - Action: sts:AssumeRole
            Effect: Allow
            Principal:
              AWS:
                Fn::GetAtt:
                - KiamAWSIAMRole
                - Arn
          Version: "2012-10-17"
        ManagedPolicyArns:
        - Ref: ExternalDnsAWSIAMManagedPolicy
        RoleName: development-external-dns-role
      Type: AWS::IAM::Role
    ExternalSecretsAWSIAMManagedPolicy:
      Properties:
        PolicyDocument:
          Statement:
          - Action: secretsmanager:GetSecretValue
            Effect: Allow
            Resource:
            - arn:aws:secretsmanager:us-west-2:123456789012:secret:development/*
          Version: "2012-10-17"
      Type: AWS::IAM::ManagedPolicy
    ExternalSecretsAWSIAMRole:
      Properties:
        AssumeRolePolicyDocument:
          Statement:
          - Action: sts:AssumeRole
            Effect: Allow
            Principal:
              Service: ec2.amazonaws.com
          - Action: sts:AssumeRole
            Effect: Allow
            Principal:
              AWS:
                Fn::GetAtt:
                - KiamAWSIAMRole
                - Arn
          Version: "2012-10-17"
        ManagedPolicyArns:
        - Ref: ExternalSecretsAWSIAMManagedPolicy
        RoleName: development-external-secrets-role
      Type: AWS::IAM::Role
    KiamAWSIAMManagedPolicy:
      Properties:
        PolicyDocument:
          Statement:
          - Action: sts:AssumeRole
            Effect: Allow
            Resource: '*'
          Version: "2012-10-17"
      Type: AWS::IAM::ManagedPolicy
    KiamAWSIAMRole:
      Properties:
        AssumeRolePolicyDocument:
          Statement:
          - Action: sts:AssumeRole
            Effect: Allow
            Principal:
              AWS:
                Fn::ImportValue: eksctl-development-nodegroup-ng-kiam::InstanceRoleARN
          - Action: sts:AssumeRole
            Effect: Allow
            Principal:
              Service: ec2.amazonaws.com
          Version: "2012-10-17"
        ManagedPolicyArns:
        - Ref: KiamManagedPolicy
        RoleName: development-kiam-role
      Type: AWS::IAM::Role
kind: CFTemplate
