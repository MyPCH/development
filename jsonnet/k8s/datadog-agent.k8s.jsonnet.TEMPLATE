local kube = import 'kube.jsonnet';

local Helmrelease(config, group) =
  kube.helmrelease(config, group) {
    spec+: {
      values+: {
        kubeStateMetrics: {
          enabled: config.groups.kubeStateMetrics.enabled,
        },
        datadog: {
          apiKeyExistingSecret: group.secret.name,
          appKeyExistingSecret: group.secret.name,
          tokenExistingSecret: group.secret.name,
          clusterName: config.cluster.name,
          logLevel: config.cluster.logLevel,
        },
        clusterAgent: {
          enabled: true,
          metricsProvider: {
            enabled: true,
          },
        },
      },
    },
  };

function(config) (
  local group = config.groups.datadogAgent;
  if group.enabled then {
    Helmrelease: if group.helmrelease.create then Helmrelease(config, group),
    Namespace: if group.namespace.create then kube.namespace(config, group),
  }
)
