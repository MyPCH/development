apiVersion: flux.weave.works/v1beta1
kind: HelmRelease
metadata:
  name: ambassador
  namespace: default
  annotations:
    flux.weave.works/automated: "false"
spec:
  chart:
    #git: git@github.com:helm/charts
    #path: stable/ambassador
    #ref: master
    repository: https://kubernetes-charts.storage.googleapis.com/
    name: ambassador
    version: 2.0.2
  values:
    fullnameOverride: ambassador
    replicaCount: 2
    prometheusExporter:
      enabled: true
    service:
      http:
        port: 80
      https:
        port: 443
      securityContext:
        runAsNonRoot: false
      externalTrafficPolicy: Local
      annotations:
        sidecar.istio.io/inject: "false"
        service.beta.kubernetes.io/aws-load-balancer-type: "nlb"
        service.beta.kubernetes.io/aws-load-balancer-cross-zone-load-balancing-enabled: "true"
        getambassador.io/config: |
          ---
          apiVersion: ambassador/v1
          kind: Module
          name: tls
          config:
            server:
              secret: ambassador-certs
              enabled: True
              redirect_cleartext_from: 8080
          ---
          apiVersion: ambassador/v1
          kind:  Module
          name:  ambassador
          config:
            service_port: 8443
            use_proxy_proto: false
            use_remote_address: true
            x_forwarded_proto_redirect: true
            cors:
              origins: "*"
              methods: "GET, POST, PUT, PATCH, DELETE"
              headers:  "authorization, content-type, x-tidepool-session-token, x-tidepool-trace-request, x-tidepool-trace-session"
              credentials: true
              exposed_headers: "x-tidepool-session-token, x-tidepool-trace-request, x-tidepool-trace-session"
              max_age: "0"
  
